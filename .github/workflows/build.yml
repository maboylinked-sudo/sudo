name: Mercury Smart Patcher
on: [push, workflow_dispatch]

jobs:
  patch:
    runs-on: windows-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup UABEA
        run: |
          # Automatically find and download the latest UABEA-CLI
          $repo = "nesrak1/UABEA"
          $release = Invoke-RestMethod -Uri "https://api.github.com/repos/$repo/releases/latest"
          $asset = $release.assets | Where-Object { $_.name -like "*CLI-win-x64.zip" }
          $url = $asset.browser_download_url
          Write-Host "Downloading UABEA from $url"
          Invoke-WebRequest -Uri $url -OutFile "uabea.zip"
          Expand-Archive -Path uabea.zip -DestinationPath ./uabea -Force

      - name: Auto-Find IDs and Patch
        run: |
          # 1. Get the list of all shaders in your 'shaders' file
          ./uabea/UABEAvalonia.exe info "shaders" > info.txt
          
          # 2. Automatically find the Path ID for Player and Smoke shaders
          # We use Select-String to find the name, then grab the ID number next to it
          $playerID = Select-String -Path info.txt -Pattern "pure_pbs_highlighted" | ForEach-Object { $_.Line.Trim().Split(' ')[1] }
          $smokeID = Select-String -Path info.txt -Pattern "particles_alphablend" | ForEach-Object { $_.Line.Split(' ')[1] }
          
          Write-Host "Auto-Detected Player ID: $playerID"
          Write-Host "Auto-Detected Smoke ID: $smokeID"

          # 3. Create the patch script with the IDs we just found
          $patch = @"
          modify 0 $playerID
          set m_Shader.m_Shader.ZTest 8
          set m_Shader.m_Shader.LOD 1000
          set m_Shader.m_Shader.Cull 0
          set m_Shader.m_Shader.ZWrite 0
          set m_Shader.m_Shader.ZClip 0
          set m_Shader.m_Shader.m_Queue 4000

          modify 0 $smokeID
          set m_Enabled 0
          "@
          $patch | Out-File -FilePath auto_patch.txt -Encoding ascii

          # 4. Apply the patch and compress to LZ4
          ./uabea/UABEAvalonia.exe applypatch "shaders" "auto_patch.txt" "modded_shaders" -lz4
        
      - name: Upload Result
        uses: actions/upload-artifact@v4
        with:
          name: Mercury-Finished-Bundle
          path: modded_shaders
